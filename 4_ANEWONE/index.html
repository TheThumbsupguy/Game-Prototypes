<!DOCTYPE html>
<html>

<head>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.52.0/dist/phaser-arcade-physics.min.js"></script>
</head>

<body>

  <script>
    const config = {
      type: Phaser.AUTO,
      width: 480,
      height: 270,
      pixelArt: true,
      scale: {
        mode: Phaser.Scale.FIT,
        autoCenter: Phaser.Scale.CENTER_BOTH,
        autoResize: true
      },
      physics: {
        default: 'arcade',
        arcade: {
          debug: false
        }
      },
      scene: {
        preload: preload,
        create: create,
        update: update
      }
    };
    let playerVelocity = 120;

    const game = new Phaser.Game(config);

    function preload() {
    }

    function create() {
      // Vehicles
      const vehicleConfig = [
        { color: '0xff0000', x: 16, y: game.config.height - 32 },
        { color: '0x00ff00', x: game.config.width / 2, y: game.config.height - 32 },
        { color: '0x0000ff', x: game.config.width - 32, y: game.config.height - 32 },
      ];

      this.vehicles = this.physics.add.group();

      for (let index = 0; index < vehicleConfig.length; index++) {
        const { color, x, y } = vehicleConfig[index];
        const vehicle = this.add.rectangle(x, y, 16, 16, color).setOrigin(0, 0).setName('vehicle');
        this.vehicles.add(this.physics.add.existing(vehicle));
      }

      // Player
      const playerRectangle = this.add.rectangle(game.config.width / 2, game.config.height / 2, 16, 16, "0xffffff").setOrigin(0, 0).setName('player');
      this.player = this.physics.add.existing(playerRectangle);

      // Initialize active objects
      this.activeObjects = this.physics.add.group([this.player]);

      // Controls
      this.cursors = this.input.keyboard.createCursorKeys();
      this.cursors.space.on('down', keyDownHandler, this);
    }

    function update() {
      const { up, right, down, left, space } = this.cursors;

      // Stop non-active vehicles
      this.vehicles.children.iterate(vehicle => {
        if (vehicle.body.velocity.x != 0 || vehicle.body.velocity.y != 0) {
          vehicle.body.setVelocity(0);
        }
      });

      if (up.isDown) {
        this.activeObjects.children.iterate((object) => object.body.setVelocityY(-playerVelocity));
      } else if (down.isDown) {
        this.activeObjects.children.iterate((object) => object.body.setVelocityY(playerVelocity));
      } else {
        this.activeObjects.children.iterate((object) => object.body.setVelocityY(0));
      }

      if (left.isDown) {
        this.activeObjects.children.iterate((object) => object.body.setVelocityX(-playerVelocity));
      } else if (right.isDown) {
        this.activeObjects.children.iterate((object) => object.body.setVelocityX(playerVelocity));
      } else {
        this.activeObjects.children.iterate((object) => object.body.setVelocityX(0));
      }
    }

    function keyDownHandler() {
      // For each vehicle on the map...
      this.vehicles.children.iterate((vehicle) => {
        // Check if the player overlaps a vehicle.
        if (this.physics.world.intersects(this.player.body, vehicle.body)) {
          // If so, attach vehicle to player, otherwise detach vehicle from player.
          if (!this.activeObjects.contains(vehicle)) {
            this.activeObjects.add(vehicle);
          } else if (this.activeObjects.contains(vehicle)) {
            this.activeObjects.remove(vehicle);
          }
        }
      });
    }

  </script>

</body>

</html>
