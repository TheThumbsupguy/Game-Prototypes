<!DOCTYPE html>
<html>

<head>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.52.0/dist/phaser-arcade-physics.min.js"></script>
</head>

<body>

  <script>
    const config = {
      type: Phaser.AUTO,
      width: 480,
      height: 270,
      pixelArt: true,
      scale: {
        mode: Phaser.Scale.FIT,
        autoCenter: Phaser.Scale.CENTER_BOTH,
        autoResize: true
      },
      physics: {
        default: 'arcade',
        arcade: {
          debug: false
        }
      },
      scene: {
        preload: preload,
        create: create,
        update: update
      }
    };
    const PLAYER_VELOCITY = 120;

    const game = new Phaser.Game(config);

    function preload() {
    }

    function create() {
      // Vehicles
      const vehicleConfig = [
        { color: '0xff0000', x: 16, y: 16, name: 'red' },
        { color: '0xffff00', x: 16, y: game.config.height / 2 - 8, name: 'yellow' },
        { color: '0x0000ff', x: 16, y: game.config.height - 32, name: 'blue' },
        { color: '0xff6600', x: game.config.width - 32, y: 16, name: 'orange' },
        { color: '0x00ff00', x: game.config.width - 32, y: game.config.height / 2 - 8, name: 'green' },
        { color: '0x6600ff', x: game.config.width - 32, y: game.config.height - 32, name: 'purple' },
      ];

      this.vehicles = this.physics.add.group();

      for (let index = 0; index < vehicleConfig.length; index++) {
        const { color, x, y, name } = vehicleConfig[index];
        const vehicle = this.add.rectangle(x, y, 16, 16, color)
          .setOrigin(0, 0)
          .setName(name);
        this.vehicles.add(vehicle);
      }

      // Ammo
      const ammoDefault = this.textures.createCanvas('ammo-default', 8, 8);
      ammoDefault.context.fillStyle = '#ffffff';
      ammoDefault.context.fillRect(0, 0, 8, 8);
      ammoDefault.refresh();
      this.ammoDefault = this.physics.add.group({
        maxSize: 30,
      });

      const ammoRed = this.textures.createCanvas('ammo-red', 8, 8);
      ammoRed.context.fillStyle = '#ff0000';
      ammoRed.context.fillRect(0, 0, 8, 8);
      ammoRed.refresh();
      this.ammoRed = this.physics.add.group({
        maxSize: 30,
      });

      const ammoOrange = this.textures.createCanvas('ammo-orange', 8, 8);
      ammoOrange.context.fillStyle = '#ff6600';
      ammoOrange.context.fillRect(0, 0, 8, 8);
      ammoOrange.refresh();
      this.ammoOrange = this.physics.add.group({
        maxSize: 30,
      });

      const ammoYellow = this.textures.createCanvas('ammo-yellow', 8, 8);
      ammoYellow.context.fillStyle = '#ffff00';
      ammoYellow.context.fillRect(0, 0, 8, 8);
      ammoYellow.refresh();
      this.ammoYellow = this.physics.add.group({
        maxSize: 30,
      });

      // Shield
      const shield2 = this.add.rectangle(0, 0, 32, 32, '0x0000ff')
        .setOrigin(0, 0)
        .setName('shield2')
        .setDepth(this.vehicles.children.size)
        .setVisible(false)
        .setActive(false);

      this.shield2 = this.physics.add.existing(shield2);

      const shield = this.add.rectangle(0, 0, 24, 24, '0x6600ff')
        .setOrigin(0, 0)
        .setName('shield')
        .setDepth(this.vehicles.children.size)
        .setVisible(false)
        .setActive(false);

      this.shield = this.physics.add.existing(shield);

      // Player
      const playerRectangle = this.add.rectangle(game.config.width / 2 - 8, game.config.height / 2 - 8, 16, 16, "0xffffff")
        .setOrigin(0, 0)
        .setName('player')
        .setDepth(this.vehicles.children.size);
      this.player = this.physics.add.existing(playerRectangle);

      // Initialize active objects
      this.activeObjects = this.physics.add.group();

      // Controls
      this.cursors = this.input.keyboard.createCursorKeys();
      this.cursors.space.on('down', spaceKeyDown, this);
      this.cursors.shift.on('down', shiftKeyDown, this);
    }

    function update(time, delta) {
      const { up, right, down, left, space, shift } = this.cursors;
      const velocity = getVelocity.call(this);

      // Stop non-active vehicles
      this.vehicles.children.each(vehicle => {
        if (vehicle.body.velocity.x != 0 || vehicle.body.velocity.y != 0) {
          vehicle.body.setVelocity(0);
        }
      });

      // Ammo
      this.ammoDefault.children.union(
        this.ammoRed.children.union(
          this.ammoOrange.children.union(
            this.ammoYellow.children
          )
        )
      ).each(ammo => {
        if (ammo.active) {
          if (ammo.lifespan > 0) {
            ammo.lifespan -= delta;
          } else {
            ammo.setActive(false);
            ammo.setVisible(false);
            ammo.setVelocityY(0);
          }
        }
      });

      // Update player position
      if (up.isDown) {
        this.player.body.setVelocityY(-velocity);
      } else if (down.isDown) {
        this.player.body.setVelocityY(velocity);
      } else {
        this.player.body.setVelocityY(0);
      }

      if (left.isDown) {
        this.player.body.setVelocityX(-velocity);
      } else if (right.isDown) {
        this.player.body.setVelocityX(velocity);
      } else {
        this.player.body.setVelocityX(0);
      }

      // Update shield position
      if (this.activeObjects.children.get('name', 'purple')) {
        if (up.isDown) {
          this.shield.body.setVelocityY(-velocity);
        } else if (down.isDown) {
          this.shield.body.setVelocityY(velocity);
        } else {
          this.shield.body.setVelocityY(0);
        }

        if (left.isDown) {
          this.shield.body.setVelocityX(-velocity);
        } else if (right.isDown) {
          this.shield.body.setVelocityX(velocity);
        } else {
          this.shield.body.setVelocityX(0);
        }
      }

      if (this.activeObjects.children.get('name', 'blue')) {
        if (up.isDown) {
          this.shield2.body.setVelocityY(-velocity);
        } else if (down.isDown) {
          this.shield2.body.setVelocityY(velocity);
        } else {
          this.shield2.body.setVelocityY(0);
        }

        if (left.isDown) {
          this.shield2.body.setVelocityX(-velocity);
        } else if (right.isDown) {
          this.shield2.body.setVelocityX(velocity);
        } else {
          this.shield2.body.setVelocityX(0);
        }
      }

      // Update vehicle positions
      let previous;
      this.activeObjects.children.intersect(this.vehicles.children).each((vehicle, index) => {
        const dx = (previous ? previous.x : this.player.x) - vehicle.x;
        const dy = (previous ? previous.y : this.player.y) - vehicle.y;
        const vx = dx * 4;
        const vy = dy * 4;
        vehicle.body.setVelocity(vx, vy);
        previous = vehicle;
      });
    }

    function getVelocity() {
      if (this.activeObjects.children.get('name', 'green')) {
        return PLAYER_VELOCITY * 2;
      }
      return PLAYER_VELOCITY;
    }

    function fireAmmo() {
      let ammo;

      if (this.activeObjects.children.get('name', 'yellow')) {
        for (let index = 0; index < 2; index++) {
          ammo = this.ammoYellow.get(this.player.x + 8, this.player.y + 8, 'ammo-yellow');
          if (ammo) {
            ammo.setActive(true);
            ammo.setVisible(true);
            ammo.lifespan = 1000;
            ammo.body.setVelocityY(-160);
            ammo.body.setVelocityX(index ? 60 : -60);
          }
        }
      }

      if (this.activeObjects.children.get('name', 'orange')) {
        for (let index = 0; index < 2; index++) {
          ammo = this.ammoOrange.get(this.player.x + 8, this.player.y + 8, 'ammo-orange');
          if (ammo) {
            ammo.setActive(true);
            ammo.setVisible(true);
            ammo.lifespan = 1000;
            ammo.body.setVelocityY(-180);
            ammo.body.setVelocityX(index ? 40 : -40);
          }
        }
      }

      if (this.activeObjects.children.get('name', 'red')) {
        for (let index = 0; index < 2; index++) {
          ammo = this.ammoRed.get(this.player.x + 8, this.player.y + 8, 'ammo-red');
          if (ammo) {
            ammo.setActive(true);
            ammo.setVisible(true);
            ammo.lifespan = 1000;
            ammo.body.setVelocityY(-195);
            ammo.body.setVelocityX(index ? 20 : -20);
          }
        }
      }

      ammo = this.ammoDefault.get(this.player.x + 8, this.player.y + 8, 'ammo-default');
      if (ammo) {
        ammo.setActive(true);
        ammo.setVisible(true);
        ammo.lifespan = 1000;
        ammo.body.setVelocityY(-200);
        ammo.body.setVelocityX(0);
      }
    }

    function spaceKeyDown() {
      // For each vehicle on the map...
      this.vehicles.children.each(vehicle => {
        // Check if the player overlaps a vehicle.
        if (this.physics.world.intersects(this.player.body, vehicle.body)) {
          // If so, attach vehicle to player, otherwise detach vehicle from player.
          if (!this.activeObjects.contains(vehicle)) {
            const index = this.activeObjects.children.size - 1;
            const x = this.player.x;
            const y = this.player.y + ((index + 1) * 8);
            const depth = this.vehicles.children.size - (index + 1);

            vehicle.setDepth(depth);

            this.activeObjects.add(vehicle);

            if (vehicle.name == 'purple') {
              this.shield.setVisible(true);
              this.shield.setActive(true);
              this.shield.setPosition(this.player.x - 4, this.player.y - 4);
            }

            if (vehicle.name == 'blue') {
              this.shield2.setVisible(true);
              this.shield2.setActive(true);
              this.shield2.setPosition(this.player.x - 8, this.player.y - 8);
            }
          }
        }
      });

      fireAmmo.call(this);
    }

    function shiftKeyDown() {
      this.vehicles.children.iterate(vehicle => {
        if (this.activeObjects.contains(vehicle)) {
          this.activeObjects.remove(vehicle);
          if (vehicle.name == 'purple') {
            this.shield.setVisible(false);
            this.shield.setActive(false);
          }
          if (vehicle.name == 'blue') {
            this.shield2.setVisible(false);
            this.shield2.setActive(false);
          }
        }
      });
    }

  </script>

</body>

</html>
