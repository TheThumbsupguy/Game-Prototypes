<!DOCTYPE html>
<html>

<head>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.52.0/dist/phaser-arcade-physics.min.js"></script>
</head>

<body>

  <script>
    const config = {
      type: Phaser.AUTO,
      width: 480,
      height: 270,
      pixelArt: true,
      scale: {
        mode: Phaser.Scale.FIT,
        autoCenter: Phaser.Scale.CENTER_BOTH,
        autoResize: true
      },
      physics: {
        default: 'arcade',
        arcade: {
          debug: false
        }
      },
      scene: {
        preload: preload,
        create: create,
        update: update
      }
    };
    const PLAYER_VELOCITY = 120;

    const game = new Phaser.Game(config);

    function preload() {
    }

    function create() {
      // Vehicles
      const vehicleConfig = [
        { color: '0xff0000', x: 16, y: 16, name: 'red' },
        { color: '0xffff00', x: 16, y: game.config.height / 2 - 8, name: 'yellow' },
        { color: '0x0000ff', x: 16, y: game.config.height - 32, name: 'blue' },
        { color: '0xff6600', x: game.config.width - 32, y: 16, name: 'orange' },
        { color: '0x00ff00', x: game.config.width - 32, y: game.config.height / 2 - 8, name: 'green' },
        { color: '0x6600ff', x: game.config.width - 32, y: game.config.height - 32, name: 'purple' },
      ];

      this.vehicles = this.physics.add.group();

      for (let index = 0; index < vehicleConfig.length; index++) {
        const { color, x, y } = vehicleConfig[index];
        const vehicle = this.add.rectangle(x, y, 16, 16, color)
          .setOrigin(0, 0)
          .setName('vehicle');
        this.vehicles.add(vehicle);
      }

      // Ammo
      const texture = this.textures.createCanvas('ammo', 8, 8);
      texture.context.fillStyle = '#ffffff';
      texture.context.fillRect(0, 0, 8, 8);
      texture.refresh();
      this.ammo = this.physics.add.group({
        maxSize: 30,
      });

      // Player
      const playerRectangle = this.add.rectangle(game.config.width / 2 - 8, game.config.height / 2 - 8, 16, 16, "0xffffff")
        .setOrigin(0, 0)
        .setName('player')
        .setDepth(this.vehicles.children.size);
      this.player = this.physics.add.existing(playerRectangle);

      // Initialize active objects
      this.activeObjects = this.physics.add.group();

      // Controls
      this.cursors = this.input.keyboard.createCursorKeys();
      this.cursors.space.on('down', spaceKeyDown, this);
      this.cursors.shift.on('down', shiftKeyDown, this);
    }

    function update(time, delta) {
      const { up, right, down, left, space, shift } = this.cursors;

      // Stop non-active vehicles
      this.vehicles.children.each(vehicle => {
        if (vehicle.body.velocity.x != 0 || vehicle.body.velocity.y != 0) {
          vehicle.body.setVelocity(0);
        }
      });

      // Ammo
      this.ammo.children.each(ammo => {
        if (ammo.active) {
          if (ammo.lifespan > 0) {
            ammo.lifespan -= delta;
          } else {
            ammo.setActive(false);
            ammo.setVisible(false);
            ammo.setVelocityY(0);
          }
        }
      });

      // Update player position
      if (up.isDown) {
        this.player.body.setVelocityY(-PLAYER_VELOCITY);
      } else if (down.isDown) {
        this.player.body.setVelocityY(PLAYER_VELOCITY);
      } else {
        this.player.body.setVelocityY(0);
      }

      if (left.isDown) {
        this.player.body.setVelocityX(-PLAYER_VELOCITY);
      } else if (right.isDown) {
        this.player.body.setVelocityX(PLAYER_VELOCITY);
      } else {
        this.player.body.setVelocityX(0);
      }

      // Update vehicle positions
      let previous;
      this.activeObjects.children.intersect(this.vehicles.children).each((vehicle, index) => {
        const dx = (previous ? previous.x : this.player.x) - vehicle.x;
        const dy = (previous ? previous.y : this.player.y) - vehicle.y;
        const vx = dx * 4;
        const vy = dy * 4;
        vehicle.body.setVelocity(vx, vy);
        previous = vehicle;
      });
    }

    function spaceKeyDown() {
      // For each vehicle on the map...
      this.vehicles.children.each(vehicle => {
        // Check if the player overlaps a vehicle.
        if (this.physics.world.intersects(this.player.body, vehicle.body)) {
          // If so, attach vehicle to player, otherwise detach vehicle from player.
          if (!this.activeObjects.contains(vehicle)) {
            const index = this.activeObjects.children.size - 1;
            const x = this.player.x;
            const y = this.player.y + ((index + 1) * 8);
            const depth = this.vehicles.children.size - (index + 1);

            vehicle.setDepth(depth);

            this.activeObjects.add(vehicle);
          }
        }
      });

      const ammo = this.ammo.get(this.player.x + 8, this.player.y + 8, 'ammo');
      ammo.setActive(true);
      ammo.setVisible(true);
      ammo.lifespan = 1000;
      ammo.body.setVelocityY(-200);
    }

    function shiftKeyDown() {
      this.vehicles.children.iterate(vehicle => {
        if (this.activeObjects.contains(vehicle)) {
          this.activeObjects.remove(vehicle);
        }
      });
    }

  </script>

</body>

</html>
